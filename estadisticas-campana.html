<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas de Campa√±a | AT&T - ExpertCell</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --att-blue: #00A8E1; --att-blue-dark: #0057B8; --white: #FFFFFF; --gray-50: #F8FAFC; --gray-100: #F1F5F9; --gray-200: #E2E8F0; --gray-500: #64748B; --gray-700: #334155; --gray-800: #1E293B; --success: #10B981; --warning: #F59E0B; --danger: #EF4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; padding: 20px; color: var(--gray-800); }
        .container { max-width: 1100px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, var(--att-blue) 0%, var(--att-blue-dark) 100%); padding: 30px; border-radius: 16px; margin-bottom: 24px; text-align: center; color: white; }
        .header h1 { font-size: 28px; margin-bottom: 8px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .filters-card { background: white; border-radius: 16px; padding: 25px; margin-bottom: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .filters-card h3 { font-size: 16px; color: var(--gray-700); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
        .filter-group label { display: block; font-size: 13px; color: var(--gray-500); margin-bottom: 6px; font-weight: 500; }
        .filter-group select, .filter-group input { width: 100%; padding: 10px 12px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; color: var(--gray-700); background: white; cursor: pointer; }
        .filter-group select:focus, .filter-group input:focus { outline: none; border-color: var(--att-blue); }
        .btn-filter { background: linear-gradient(135deg, var(--att-blue) 0%, var(--att-blue-dark) 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-filter:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,168,225,0.3); }
        .btn-reset { background: var(--gray-100); color: var(--gray-700); border: 2px solid var(--gray-200); padding: 10px 20px; border-radius: 8px; font-size: 14px; cursor: pointer; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 24px; }
        .stat-card { background: white; border-radius: 16px; padding: 30px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .stat-card.blue::before { background: var(--att-blue); }
        .stat-card.green::before { background: var(--success); }
        .stat-card.red::before { background: var(--danger); }
        .stat-icon { font-size: 40px; margin-bottom: 15px; }
        .stat-number { font-size: 48px; font-weight: 700; margin-bottom: 5px; }
        .stat-card.blue .stat-number { color: var(--att-blue); }
        .stat-card.green .stat-number { color: var(--success); }
        .stat-card.red .stat-number { color: var(--danger); }
        .stat-label { font-size: 14px; color: var(--gray-500); font-weight: 500; }
        .rate-card { background: white; border-radius: 16px; padding: 30px; margin-bottom: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .rate-card h3 { font-size: 18px; color: var(--gray-700); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .progress-container { background: var(--gray-100); border-radius: 12px; height: 40px; overflow: hidden; position: relative; margin-bottom: 15px; }
        .progress-bar { height: 100%; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; transition: width 1s ease; }
        .progress-bar.good { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); }
        .progress-bar.medium { background: linear-gradient(135deg, var(--warning) 0%, #D97706 100%); }
        .progress-bar.bad { background: linear-gradient(135deg, var(--danger) 0%, #DC2626 100%); }
        .rate-legend { display: flex; justify-content: space-between; font-size: 13px; color: var(--gray-500); }
        .interpretation { background: var(--gray-50); border-radius: 10px; padding: 15px; margin-top: 20px; display: flex; align-items: flex-start; gap: 12px; }
        .interpretation-icon { font-size: 24px; }
        .interpretation-text h4 { font-size: 14px; color: var(--gray-700); margin-bottom: 4px; }
        .interpretation-text p { font-size: 13px; color: var(--gray-500); line-height: 1.5; }
        .breakdown-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .breakdown-card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .breakdown-card h3 { font-size: 16px; color: var(--gray-700); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .breakdown-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--gray-100); }
        .breakdown-item:last-child { border-bottom: none; }
        .breakdown-item .label { font-size: 14px; color: var(--gray-700); display: flex; align-items: center; gap: 8px; }
        .breakdown-item .values { display: flex; gap: 15px; font-size: 14px; }
        .breakdown-item .approved { color: var(--success); font-weight: 600; }
        .breakdown-item .rejected { color: var(--danger); font-weight: 600; }
        .breakdown-item .total { color: var(--gray-500); font-size: 12px; }
        .active-filter-tag { display: inline-flex; align-items: center; gap: 6px; background: var(--att-blue); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; margin-right: 8px; margin-bottom: 8px; }
        .active-filters { margin-bottom: 15px; }
        .loading { display: flex; justify-content: center; align-items: center; padding: 60px; }
        .spinner { width: 50px; height: 50px; border: 4px solid var(--gray-200); border-top-color: var(--att-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 40px; color: var(--gray-500); }
        .week-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--gray-100); }
        .week-row:last-child { border-bottom: none; }
        .week-label { width: 120px; font-size: 13px; color: var(--gray-600); font-weight: 500; }
        .week-bar-container { flex: 1; display: flex; align-items: center; gap: 10px; }
        .week-bar { height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 12px; font-weight: 600; min-width: 30px; }
        .week-bar.approved { background: var(--success); }
        .week-bar.rejected { background: var(--danger); }
        @media (max-width: 768px) { .stats-grid, .breakdown-grid { grid-template-columns: 1fr; } .stat-number { font-size: 36px; } .filters-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Estad√≠sticas de Campa√±a</h1>
            <p>M√©tricas del formulario de pre-filtro</p>
        </div>
        <div class="filters-card">
            <h3>üîç Filtros</h3>
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Sucursal</label>
                    <select id="filtro-sucursal">
                        <option value="">Todas las sucursales</option>
                        <option value="Torre JV Ju√°rez">Torre JV Ju√°rez</option>
                        <option value="Edificio Inbursa Antequera">Edificio Inbursa Antequera</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Per√≠odo</label>
                    <select id="filtro-periodo">
                        <option value="">Todo el tiempo</option>
                        <option value="hoy">Hoy</option>
                        <option value="semana">Esta semana</option>
                        <option value="mes">Este mes</option>
                        <option value="personalizado">Personalizado</option>
                    </select>
                </div>
                <div class="filter-group" id="fecha-inicio-group" style="display: none;">
                    <label>Fecha inicio</label>
                    <input type="date" id="fecha-inicio">
                </div>
                <div class="filter-group" id="fecha-fin-group" style="display: none;">
                    <label>Fecha fin</label>
                    <input type="date" id="fecha-fin">
                </div>
                <div class="filter-group" style="display: flex; gap: 10px; align-items: flex-end;">
                    <button class="btn-filter" onclick="aplicarFiltros()">üîÑ Aplicar</button>
                    <button class="btn-reset" onclick="resetFiltros()">Limpiar</button>
                </div>
            </div>
        </div>
        <div id="content"><div class="loading"><div class="spinner"></div></div></div>
    </div>
    <script>
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby-HOsviZvkv83Lrsu6cFukqRK6uuft9nw438lxPv2WOX_prRx3CfosVF7-BxuwBJCQ9A/exec';
let datosGlobales = null;

document.getElementById('filtro-periodo').addEventListener('change', function() {
    const mostrar = this.value === 'personalizado';
    document.getElementById('fecha-inicio-group').style.display = mostrar ? 'block' : 'none';
    document.getElementById('fecha-fin-group').style.display = mostrar ? 'block' : 'none';
});

async function cargarEstadisticas() {
    const content = document.getElementById('content');
    content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getEstadisticasCampanaV2');
        const data = await response.json();
        if (data.status === 'success') {
            datosGlobales = data;
            aplicarFiltros();
        } else { throw new Error('Error'); }
    } catch (error) {
        content.innerHTML = '<div class="empty-state"><p>‚ö†Ô∏è Error al cargar</p><button class="btn-filter" onclick="cargarEstadisticas()" style="margin-top:20px">üîÑ Reintentar</button></div>';
    }
}

function aplicarFiltros() {
    if (!datosGlobales) return;
    const filtroSucursal = document.getElementById('filtro-sucursal').value;
    const filtroPeriodo = document.getElementById('filtro-periodo').value;
    const fechaInicio = document.getElementById('fecha-inicio').value;
    const fechaFin = document.getElementById('fecha-fin').value;
    
    let aprobados = datosGlobales.aprobados || [];
    let rechazados = datosGlobales.rechazados || [];
    
    if (filtroSucursal) {
        aprobados = aprobados.filter(r => r.sucursal === filtroSucursal);
        rechazados = rechazados.filter(r => r.sucursal === filtroSucursal);
    }
    
    const hoy = new Date(); hoy.setHours(0,0,0,0);
    if (filtroPeriodo === 'hoy') {
        aprobados = aprobados.filter(r => esMismaFecha(r.fecha, hoy));
        rechazados = rechazados.filter(r => esMismaFecha(r.fecha, hoy));
    } else if (filtroPeriodo === 'semana') {
        const inicio = new Date(hoy); inicio.setDate(hoy.getDate() - hoy.getDay());
        aprobados = aprobados.filter(r => new Date(r.fecha) >= inicio);
        rechazados = rechazados.filter(r => new Date(r.fecha) >= inicio);
    } else if (filtroPeriodo === 'mes') {
        const inicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
        aprobados = aprobados.filter(r => new Date(r.fecha) >= inicio);
        rechazados = rechazados.filter(r => new Date(r.fecha) >= inicio);
    } else if (filtroPeriodo === 'personalizado' && fechaInicio && fechaFin) {
        const inicio = new Date(fechaInicio);
        const fin = new Date(fechaFin); fin.setHours(23,59,59,999);
        aprobados = aprobados.filter(r => { const f = new Date(r.fecha); return f >= inicio && f <= fin; });
        rechazados = rechazados.filter(r => { const f = new Date(r.fecha); return f >= inicio && f <= fin; });
    }
    renderEstadisticas(aprobados, rechazados, filtroSucursal, filtroPeriodo);
}

function esMismaFecha(f1, f2) { return new Date(f1).toDateString() === new Date(f2).toDateString(); }
function resetFiltros() {
    document.getElementById('filtro-sucursal').value = '';
    document.getElementById('filtro-periodo').value = '';
    document.getElementById('fecha-inicio').value = '';
    document.getElementById('fecha-fin').value = '';
    document.getElementById('fecha-inicio-group').style.display = 'none';
    document.getElementById('fecha-fin-group').style.display = 'none';
    aplicarFiltros();
}

function renderEstadisticas(aprobados, rechazados, filtroSucursal, filtroPeriodo) {
    const totalApr = aprobados.length, totalRej = rechazados.length, total = totalApr + totalRej;
    const tasa = total > 0 ? Math.round((totalApr / total) * 100) : 0;
    let progClass = tasa >= 70 ? 'good' : tasa >= 50 ? 'medium' : 'bad';
    const interp = tasa >= 80 ? {icon:'üéØ',title:'¬°Excelente!',text:'Tu campa√±a llega al p√∫blico correcto.'} :
                   tasa >= 60 ? {icon:'üëç',title:'Buena segmentaci√≥n',text:'Funciona bien, puedes mejorar.'} :
                   tasa >= 40 ? {icon:'‚ö†Ô∏è',title:'Mejorable',text:'Muchos no cumplen el perfil.'} :
                               {icon:'üî¥',title:'Requiere atenci√≥n',text:'Revisa la segmentaci√≥n urgente.'};
    
    const sucursales = ['Torre JV Ju√°rez', 'Edificio Inbursa Antequera'];
    let sucHTML = '';
    sucursales.forEach(suc => {
        const apr = aprobados.filter(r => r.sucursal === suc).length;
        const rej = rechazados.filter(r => r.sucursal === suc).length;
        const tot = apr + rej, tasaSuc = tot > 0 ? Math.round((apr/tot)*100) : 0;
        const icon = suc.includes('Torre') ? 'üè¢' : 'üèõÔ∏è';
        sucHTML += `<div class="breakdown-item"><span class="label">${icon} ${suc}</span><div class="values"><span class="approved">‚úÖ ${apr}</span><span class="rejected">‚ùå ${rej}</span><span class="total">(${tasaSuc}%)</span></div></div>`;
    });
    
    const semanasHTML = generarSemanas(aprobados, rechazados);
    
    let filtrosHTML = '';
    if (filtroSucursal || filtroPeriodo) {
        filtrosHTML = '<div class="active-filters">';
        if (filtroSucursal) filtrosHTML += `<span class="active-filter-tag">üìç ${filtroSucursal}</span>`;
        if (filtroPeriodo) {
            const txt = {hoy:'Hoy',semana:'Esta semana',mes:'Este mes',personalizado:'Personalizado'}[filtroPeriodo];
            filtrosHTML += `<span class="active-filter-tag">üìÖ ${txt}</span>`;
        }
        filtrosHTML += '</div>';
    }
    
    document.getElementById('content').innerHTML = `
        ${filtrosHTML}
        <div class="stats-grid">
            <div class="stat-card blue"><div class="stat-icon">üì•</div><div class="stat-number">${total}</div><div class="stat-label">Total Postulantes</div></div>
            <div class="stat-card green"><div class="stat-icon">‚úÖ</div><div class="stat-number">${totalApr}</div><div class="stat-label">Aprobados Pre-Filtro</div></div>
            <div class="stat-card red"><div class="stat-icon">‚ùå</div><div class="stat-number">${totalRej}</div><div class="stat-label">Rechazados Pre-Filtro</div></div>
        </div>
        <div class="rate-card">
            <h3>üìà Tasa de Aprobaci√≥n</h3>
            <div class="progress-container"><div class="progress-bar ${progClass}" style="width:${Math.max(tasa,5)}%">${tasa}%</div></div>
            <div class="rate-legend"><span>0% - Baja</span><span>100% - Alta</span></div>
            <div class="interpretation"><div class="interpretation-icon">${interp.icon}</div><div class="interpretation-text"><h4>${interp.title}</h4><p>${interp.text}</p></div></div>
        </div>
        <div class="breakdown-grid">
            <div class="breakdown-card"><h3>üè¢ Por Sucursal</h3>${sucHTML||'<div class="empty-state">Sin datos</div>'}</div>
            <div class="breakdown-card"><h3>üìÖ √öltimas 4 Semanas</h3>${semanasHTML}</div>
        </div>
        <div class="rate-card" style="margin-top:24px"><h3>üí° Recomendaciones</h3><div style="padding:10px 0;font-size:14px;color:var(--gray-600);line-height:1.8">
            ${tasa < 60 ? '<p>‚Ä¢ Revisa requisitos del anuncio</p><p>‚Ä¢ Segmenta mejor por zona</p><p>‚Ä¢ Aclara esquema de comisiones</p>' : '<p>‚Ä¢ ‚úÖ Campa√±a bien segmentada</p><p>‚Ä¢ Monitorea semanalmente</p><p>‚Ä¢ Replica estrategia exitosa</p>'}
        </div></div>`;
}

function generarSemanas(aprobados, rechazados) {
    const semanas = [], hoy = new Date();
    for (let i = 0; i < 4; i++) {
        const fin = new Date(hoy); fin.setDate(hoy.getDate() - (i * 7));
        const inicio = new Date(fin); inicio.setDate(fin.getDate() - 6);
        const apr = aprobados.filter(r => { const f = new Date(r.fecha); return f >= inicio && f <= fin; }).length;
        const rej = rechazados.filter(r => { const f = new Date(r.fecha); return f >= inicio && f <= fin; }).length;
        const label = i === 0 ? 'Esta semana' : i === 1 ? 'Sem. pasada' : `Hace ${i} sem.`;
        semanas.push({label, apr, rej, total: apr + rej});
    }
    const max = Math.max(...semanas.map(s => s.total), 1);
    let html = '';
    semanas.forEach(s => {
        const wA = (s.apr/max)*100, wR = (s.rej/max)*100, t = s.total > 0 ? Math.round((s.apr/s.total)*100) : 0;
        html += `<div class="week-row"><div class="week-label">${s.label}</div><div class="week-bar-container"><div class="week-bar approved" style="width:${Math.max(wA,8)}%">${s.apr}</div><div class="week-bar rejected" style="width:${Math.max(wR,8)}%">${s.rej}</div><span style="font-size:12px;color:var(--gray-500)">(${t}%)</span></div></div>`;
    });
    return html;
}

document.addEventListener('DOMContentLoaded', cargarEstadisticas);
    </script>
</body>
</html>
