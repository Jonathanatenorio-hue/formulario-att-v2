<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas de Campa√±a | AT&T - ExpertCell</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --att-blue: #00A8E1; --att-blue-dark: #0057B8; --white: #FFFFFF; --gray-50: #F8FAFC; --gray-100: #F1F5F9; --gray-200: #E2E8F0; --gray-500: #64748B; --gray-700: #334155; --gray-800: #1E293B; --success: #10B981; --warning: #F59E0B; --danger: #EF4444; --purple: #8B5CF6; --pink: #EC4899; --indigo: #6366F1; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; padding: 20px; color: var(--gray-800); }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header { background: linear-gradient(135deg, var(--att-blue) 0%, var(--att-blue-dark) 100%); padding: 30px; border-radius: 16px; margin-bottom: 24px; color: white; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header-left h1 { font-size: 28px; margin-bottom: 8px; }
        .header-left p { opacity: 0.9; font-size: 14px; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .live-badge { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .live-dot { width: 10px; height: 10px; background: #10B981; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .btn-config { background: rgba(255,255,255,0.2); border: none; padding: 10px 16px; border-radius: 8px; color: white; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 6px; }
        .btn-config:hover { background: rgba(255,255,255,0.3); }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 16px; padding: 30px; max-width: 450px; width: 90%; }
        .modal h3 { font-size: 20px; margin-bottom: 20px; color: var(--gray-800); display: flex; align-items: center; gap: 10px; }
        .modal-field { margin-bottom: 20px; }
        .modal-field label { display: block; font-size: 14px; color: var(--gray-600); margin-bottom: 8px; }
        .modal-field input { width: 100%; padding: 12px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; }
        .modal-field input:focus { outline: none; border-color: var(--att-blue); }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap; }
        .modal-btn { padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; }
        .modal-btn.primary { background: var(--att-blue); color: white; }
        .modal-btn.secondary { background: var(--gray-100); color: var(--gray-700); }
        .modal-btn.danger { background: var(--danger); color: white; }
        .modal-info { background: var(--gray-50); border-radius: 8px; padding: 15px; margin-bottom: 20px; font-size: 13px; color: var(--gray-600); }
        .modal-info strong { color: var(--gray-800); }
        .fecha-corte-display { background: var(--warning); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 24px; flex-wrap: wrap; }
        .tab { background: rgba(255,255,255,0.1); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .tab:hover { background: rgba(255,255,255,0.2); }
        .tab.active { background: white; color: var(--att-blue-dark); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .filters-card { background: white; border-radius: 16px; padding: 25px; margin-bottom: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .filters-card h3 { font-size: 16px; color: var(--gray-700); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        .filter-group label { display: block; font-size: 13px; color: var(--gray-500); margin-bottom: 6px; font-weight: 500; }
        .filter-group select, .filter-group input { width: 100%; padding: 10px 12px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; color: var(--gray-700); background: white; cursor: pointer; }
        .filter-group select:focus, .filter-group input:focus { outline: none; border-color: var(--att-blue); }
        .btn-filter { background: linear-gradient(135deg, var(--att-blue) 0%, var(--att-blue-dark) 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-filter:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,168,225,0.3); }
        .btn-reset { background: var(--gray-100); color: var(--gray-700); border: 2px solid var(--gray-200); padding: 10px 20px; border-radius: 8px; font-size: 14px; cursor: pointer; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
        .stat-card { background: white; border-radius: 16px; padding: 25px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .stat-card.blue::before { background: var(--att-blue); }
        .stat-card.green::before { background: var(--success); }
        .stat-card.red::before { background: var(--danger); }
        .stat-card.purple::before { background: var(--purple); }
        .stat-icon { font-size: 36px; margin-bottom: 12px; }
        .stat-number { font-size: 42px; font-weight: 700; margin-bottom: 5px; }
        .stat-card.blue .stat-number { color: var(--att-blue); }
        .stat-card.green .stat-number { color: var(--success); }
        .stat-card.red .stat-number { color: var(--danger); }
        .stat-card.purple .stat-number { color: var(--purple); }
        .stat-label { font-size: 13px; color: var(--gray-500); font-weight: 500; }
        
        .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 24px; }
        .chart-card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .chart-card h3 { font-size: 16px; color: var(--gray-700); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .chart-container { position: relative; height: 280px; }
        
        .funnel-card { background: white; border-radius: 16px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); margin-bottom: 24px; }
        .funnel-card h3 { font-size: 18px; color: var(--gray-700); margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
        .funnel-container { display: flex; justify-content: center; align-items: flex-end; gap: 20px; padding: 20px 0; flex-wrap: wrap; }
        .funnel-stage { text-align: center; }
        .funnel-bar { width: 100px; background: linear-gradient(180deg, var(--att-blue) 0%, var(--att-blue-dark) 100%); border-radius: 8px 8px 0 0; margin: 0 auto 15px; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 15px; color: white; font-weight: 700; font-size: 20px; transition: height 0.5s ease; min-height: 40px; }
        .funnel-bar.stage-2 { background: linear-gradient(180deg, var(--purple) 0%, #7C3AED 100%); }
        .funnel-bar.stage-3 { background: linear-gradient(180deg, var(--success) 0%, #059669 100%); }
        .funnel-label { font-size: 13px; color: var(--gray-700); font-weight: 600; margin-bottom: 5px; }
        .funnel-pct { font-size: 12px; color: var(--gray-500); }
        .funnel-arrow { font-size: 24px; color: var(--gray-300); margin-bottom: 50px; }
        
        .progress-container { background: var(--gray-100); border-radius: 12px; height: 40px; overflow: hidden; position: relative; margin-bottom: 15px; }
        .progress-bar { height: 100%; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; transition: width 1s ease; }
        .progress-bar.good { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); }
        .progress-bar.medium { background: linear-gradient(135deg, var(--warning) 0%, #D97706 100%); }
        .progress-bar.bad { background: linear-gradient(135deg, var(--danger) 0%, #DC2626 100%); }
        .rate-legend { display: flex; justify-content: space-between; font-size: 13px; color: var(--gray-500); }
        
        .breakdown-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .breakdown-card { background: white; border-radius: 16px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .breakdown-card h3 { font-size: 16px; color: var(--gray-700); margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .breakdown-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--gray-100); }
        .breakdown-item:last-child { border-bottom: none; }
        .breakdown-item .label { font-size: 14px; color: var(--gray-700); display: flex; align-items: center; gap: 8px; }
        .breakdown-item .values { display: flex; gap: 15px; font-size: 14px; }
        .breakdown-item .approved { color: var(--success); font-weight: 600; }
        .breakdown-item .rejected { color: var(--danger); font-weight: 600; }
        .breakdown-item .total { color: var(--gray-500); font-size: 12px; }
        
        .active-filter-tag { display: inline-flex; align-items: center; gap: 6px; background: var(--att-blue); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; margin-right: 8px; margin-bottom: 8px; }
        .active-filters { margin-bottom: 15px; }
        
        .compare-section { background: white; border-radius: 16px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .compare-header { display: flex; gap: 15px; align-items: end; margin-bottom: 30px; flex-wrap: wrap; }
        .compare-select { flex: 1; min-width: 180px; }
        .compare-select label { display: block; font-size: 13px; color: var(--gray-500); margin-bottom: 6px; }
        .compare-select select { width: 100%; padding: 12px; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 14px; }
        .vs-badge { background: var(--purple); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 14px; }
        .compare-results { display: grid; grid-template-columns: 1fr auto 1fr; gap: 30px; align-items: start; }
        .compare-card { background: var(--gray-50); border-radius: 12px; padding: 25px; text-align: center; }
        .compare-card.left { border-left: 4px solid var(--att-blue); }
        .compare-card.right { border-left: 4px solid var(--purple); }
        .compare-card h4 { font-size: 16px; color: var(--gray-700); margin-bottom: 20px; }
        .compare-stat { margin-bottom: 15px; }
        .compare-stat .number { font-size: 36px; font-weight: 700; }
        .compare-card.left .number { color: var(--att-blue); }
        .compare-card.right .number { color: var(--purple); }
        .compare-stat .label { font-size: 13px; color: var(--gray-500); }
        .compare-vs { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .compare-vs .vs { font-size: 24px; font-weight: 700; color: var(--gray-400); }
        .winner-badge { background: var(--success); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-top: 10px; }
        
        .loading { display: flex; justify-content: center; align-items: center; padding: 60px; }
        .spinner { width: 50px; height: 50px; border: 4px solid var(--gray-200); border-top-color: var(--att-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 40px; color: var(--gray-500); }
        .last-update { font-size: 12px; color: rgba(255,255,255,0.6); text-align: right; margin-top: 10px; }
        
        @media (max-width: 1024px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .charts-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { 
            .stats-grid, .breakdown-grid { grid-template-columns: 1fr; } 
            .stat-number { font-size: 36px; } 
            .filters-grid { grid-template-columns: 1fr; }
            .compare-results { grid-template-columns: 1fr; }
            .header { flex-direction: column; text-align: center; }
            .funnel-container { flex-direction: column; align-items: center; }
            .funnel-arrow { transform: rotate(90deg); margin: 10px 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>üìä Estad√≠sticas de Campa√±a</h1>
                <p>M√©tricas del formulario de pre-filtro</p>
            </div>
            <div class="header-right">
                <div class="live-badge">
                    <span class="live-dot"></span>
                    <span>En vivo</span>
                </div>
                <span class="fecha-corte-display" id="fecha-corte-badge" style="display:none;">
                    üìÖ Desde: <span id="fecha-corte-texto"></span>
                </span>
                <button class="btn-config" onclick="abrirConfig()">‚öôÔ∏è Configurar</button>
            </div>
        </div>
        
        <div class="modal-overlay" id="modal-config">
            <div class="modal">
                <h3>‚öôÔ∏è Configuraci√≥n</h3>
                <div class="modal-info">
                    <strong>Fecha de corte:</strong> Solo se contar√°n los registros posteriores a esta fecha. √ötil para iniciar estad√≠sticas "desde cero" sin borrar datos hist√≥ricos.
                </div>
                <div class="modal-field">
                    <label>Fecha de corte actual</label>
                    <input type="date" id="config-fecha-corte">
                </div>
                <div class="modal-field">
                    <label>Contrase√±a (para cambios)</label>
                    <input type="password" id="config-password" placeholder="Ingresa la contrase√±a">
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn secondary" onclick="cerrarConfig()">Cancelar</button>
                    <button class="modal-btn danger" onclick="reiniciarEstadisticas()">üîÑ Reiniciar desde hoy</button>
                    <button class="modal-btn primary" onclick="guardarConfig()">üíæ Guardar</button>
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('estadisticas')">üìà Estad√≠sticas</button>
            <button class="tab" onclick="showTab('graficas')">üìä Gr√°ficas</button>
            <button class="tab" onclick="showTab('comparativas')">‚öñÔ∏è Comparativas</button>
        </div>
        
        <div id="tab-estadisticas" class="tab-content active">
            <div class="filters-card">
                <h3>üîç Filtros</h3>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label>Sucursal</label>
                        <select id="filtro-sucursal">
                            <option value="">Todas</option>
                            <option value="Torre JV Ju√°rez">Torre JV Ju√°rez</option>
                            <option value="Edificio Inbursa Antequera">Edificio Inbursa Antequera</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Reclutadora</label>
                        <select id="filtro-reclutadora">
                            <option value="">Todas</option>
                            <option value="Karla Flores">Karla Flores</option>
                            <option value="Yessica Huerta">Yessica Huerta</option>
                            <option value="Jezabel Monterrosas">Jezabel Monterrosas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Fuente</label>
                        <select id="filtro-fuente">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Per√≠odo</label>
                        <select id="filtro-periodo">
                            <option value="">Todo el tiempo</option>
                            <option value="hoy">Hoy</option>
                            <option value="semana">Esta semana</option>
                            <option value="mes">Este mes</option>
                        </select>
                    </div>
                    <div class="filter-group" style="display: flex; gap: 10px;">
                        <button class="btn-filter" onclick="aplicarFiltros()">üîÑ Aplicar</button>
                        <button class="btn-reset" onclick="resetFiltros()">Limpiar</button>
                    </div>
                </div>
            </div>
            <div id="content"><div class="loading"><div class="spinner"></div></div></div>
        </div>
        
        <div id="tab-graficas" class="tab-content">
            <div id="graficas-content"><div class="loading"><div class="spinner"></div></div></div>
        </div>
        
        <div id="tab-comparativas" class="tab-content">
            <div class="compare-section">
                <h3 style="margin-bottom: 25px;">‚öñÔ∏è Comparar Rendimiento</h3>
                <div class="compare-header">
                    <div class="compare-select">
                        <label>Tipo de comparaci√≥n</label>
                        <select id="compare-tipo" onchange="actualizarOpcionesComparacion()">
                            <option value="sucursal">Por Sucursal</option>
                            <option value="reclutadora">Por Reclutadora</option>
                            <option value="fuente">Por Fuente</option>
                        </select>
                    </div>
                    <div class="compare-select">
                        <label>Opci√≥n A</label>
                        <select id="compare-a"></select>
                    </div>
                    <div class="vs-badge">VS</div>
                    <div class="compare-select">
                        <label>Opci√≥n B</label>
                        <select id="compare-b"></select>
                    </div>
                    <button class="btn-filter" onclick="ejecutarComparacion()">Comparar</button>
                </div>
                <div id="compare-results"></div>
            </div>
        </div>
        
        <p class="last-update" id="last-update-time"></p>
    </div>

    <script>
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby-HOsviZvkv83Lrsu6cFukqRK6uuft9nw438lxPv2WOX_prRx3CfosVF7-BxuwBJCQ9A/exec';
const CONFIG_PASSWORD = 'ExpertCell2026';
let datosGlobales = null;
let fechaCorte = localStorage.getItem('estadisticas_fecha_corte') || null;
let autoRefreshInterval = null;
let chartInstances = {};

function abrirConfig() {
    document.getElementById('modal-config').classList.add('active');
    document.getElementById('config-fecha-corte').value = fechaCorte || '';
    document.getElementById('config-password').value = '';
}

function cerrarConfig() {
    document.getElementById('modal-config').classList.remove('active');
}

function guardarConfig() {
    const password = document.getElementById('config-password').value;
    if (password !== CONFIG_PASSWORD) {
        alert('‚ùå Contrase√±a incorrecta');
        return;
    }
    const nuevaFecha = document.getElementById('config-fecha-corte').value;
    if (nuevaFecha) {
        fechaCorte = nuevaFecha;
        localStorage.setItem('estadisticas_fecha_corte', nuevaFecha);
        alert('‚úÖ Configuraci√≥n guardada. Las estad√≠sticas ahora cuentan desde: ' + nuevaFecha);
    } else {
        fechaCorte = null;
        localStorage.removeItem('estadisticas_fecha_corte');
        alert('‚úÖ Fecha de corte eliminada. Se muestran todos los registros.');
    }
    actualizarBadgeFechaCorte();
    cerrarConfig();
    aplicarFiltros();
}

function reiniciarEstadisticas() {
    const password = document.getElementById('config-password').value;
    if (password !== CONFIG_PASSWORD) {
        alert('‚ùå Contrase√±a incorrecta');
        return;
    }
    if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de reiniciar las estad√≠sticas desde hoy?\n\nLos datos hist√≥ricos NO se borrar√°n, pero ya no se contar√°n.')) {
        return;
    }
    const hoy = new Date().toISOString().split('T')[0];
    fechaCorte = hoy;
    localStorage.setItem('estadisticas_fecha_corte', hoy);
    actualizarBadgeFechaCorte();
    alert('‚úÖ Estad√≠sticas reiniciadas. Ahora se cuentan solo registros desde: ' + hoy);
    cerrarConfig();
    aplicarFiltros();
}

function actualizarBadgeFechaCorte() {
    const badge = document.getElementById('fecha-corte-badge');
    const texto = document.getElementById('fecha-corte-texto');
    if (fechaCorte) {
        badge.style.display = 'inline-flex';
        const fecha = new Date(fechaCorte + 'T12:00:00');
        texto.textContent = fecha.toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' });
    } else {
        badge.style.display = 'none';
    }
}

function showTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelector('[onclick="showTab(\'' + tab + '\')"]').classList.add('active');
    document.getElementById('tab-' + tab).classList.add('active');
    if (tab === 'graficas' && datosGlobales) {
        renderGraficas();
    }
}

async function cargarEstadisticas(mostrarLoader) {
    if (mostrarLoader !== false) {
        document.getElementById('content').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    }
    try {
        const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getEstadisticasCampanaV2');
        const data = await response.json();
        if (data.status === 'success') {
            datosGlobales = data;
            poblarFiltroFuentes();
            actualizarOpcionesComparacion();
            aplicarFiltros();
            const now = new Date();
            document.getElementById('last-update-time').textContent = '√öltima actualizaci√≥n: ' + now.toLocaleTimeString('es-MX');
        } else {
            throw new Error('Error en respuesta');
        }
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('content').innerHTML = '<div class="empty-state"><p>‚ö†Ô∏è Error al cargar las estad√≠sticas</p><button class="btn-filter" onclick="cargarEstadisticas()" style="margin-top:20px">üîÑ Reintentar</button></div>';
    }
}

function poblarFiltroFuentes() {
    if (!datosGlobales) return;
    const fuentes = new Set();
    [...(datosGlobales.aprobados || []), ...(datosGlobales.rechazados || [])].forEach(r => {
        if (r.fuente) fuentes.add(r.fuente);
    });
    const select = document.getElementById('filtro-fuente');
    select.innerHTML = '<option value="">Todas</option>';
    [...fuentes].sort().forEach(f => {
        select.innerHTML += '<option value="' + f + '">' + f + '</option>';
    });
}

function aplicarFiltros() {
    if (!datosGlobales) return;
    const filtroSucursal = document.getElementById('filtro-sucursal').value;
    const filtroReclutadora = document.getElementById('filtro-reclutadora').value;
    const filtroFuente = document.getElementById('filtro-fuente').value;
    const filtroPeriodo = document.getElementById('filtro-periodo').value;
    
    let aprobados = [...(datosGlobales.aprobados || [])];
    let rechazados = [...(datosGlobales.rechazados || [])];
    
    if (fechaCorte) {
        const corte = new Date(fechaCorte + 'T00:00:00');
        aprobados = aprobados.filter(r => new Date(r.fecha) >= corte);
        rechazados = rechazados.filter(r => new Date(r.fecha) >= corte);
    }
    
    if (filtroSucursal) {
        aprobados = aprobados.filter(r => r.sucursal === filtroSucursal);
        rechazados = rechazados.filter(r => r.sucursal === filtroSucursal);
    }
    
    if (filtroReclutadora) {
        aprobados = aprobados.filter(r => r.reclutadora === filtroReclutadora);
        rechazados = rechazados.filter(r => r.reclutadora === filtroReclutadora);
    }
    
    if (filtroFuente) {
        aprobados = aprobados.filter(r => r.fuente === filtroFuente);
        rechazados = rechazados.filter(r => r.fuente === filtroFuente);
    }
    
    const hoy = new Date(); hoy.setHours(0,0,0,0);
    if (filtroPeriodo === 'hoy') {
        aprobados = aprobados.filter(r => esMismaFecha(r.fecha, hoy));
        rechazados = rechazados.filter(r => esMismaFecha(r.fecha, hoy));
    } else if (filtroPeriodo === 'semana') {
        const inicio = new Date(hoy); inicio.setDate(hoy.getDate() - hoy.getDay());
        aprobados = aprobados.filter(r => new Date(r.fecha) >= inicio);
        rechazados = rechazados.filter(r => new Date(r.fecha) >= inicio);
    } else if (filtroPeriodo === 'mes') {
        const inicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
        aprobados = aprobados.filter(r => new Date(r.fecha) >= inicio);
        rechazados = rechazados.filter(r => new Date(r.fecha) >= inicio);
    }
    
    renderEstadisticas(aprobados, rechazados, {filtroSucursal, filtroReclutadora, filtroFuente, filtroPeriodo});
}

function esMismaFecha(f1, f2) { 
    return new Date(f1).toDateString() === new Date(f2).toDateString(); 
}

function resetFiltros() {
    document.getElementById('filtro-sucursal').value = '';
    document.getElementById('filtro-reclutadora').value = '';
    document.getElementById('filtro-fuente').value = '';
    document.getElementById('filtro-periodo').value = '';
    aplicarFiltros();
}

function renderEstadisticas(aprobados, rechazados, filtros) {
    const totalApr = aprobados.length;
    const totalRej = rechazados.length;
    const total = totalApr + totalRej;
    const tasa = total > 0 ? Math.round((totalApr / total) * 100) : 0;
    
    const embudo = datosGlobales.embudo || {};
    const entrevistaTelAprobada = embudo.entrevistaTelAprobada || 0;
    const panelAprobado = embudo.panelAprobado || 0;
    const capacitacionConfirmada = embudo.capacitacionConfirmada || 0;
    
    const conteoEstados = datosGlobales.conteoEstados || {};
    
    let progClass = tasa >= 70 ? 'good' : tasa >= 50 ? 'medium' : 'bad';
    
    const sucursales = ['Torre JV Ju√°rez', 'Edificio Inbursa Antequera'];
    let sucHTML = '';
    sucursales.forEach(suc => {
        const apr = aprobados.filter(r => r.sucursal === suc).length;
        const rej = rechazados.filter(r => r.sucursal === suc).length;
        const tot = apr + rej;
        const tasaSuc = tot > 0 ? Math.round((apr/tot)*100) : 0;
        const icon = suc.includes('Torre') ? 'üè¢' : 'üèõÔ∏è';
        sucHTML += '<div class="breakdown-item"><span class="label">' + icon + ' ' + suc + '</span><div class="values"><span class="approved">‚úÖ ' + apr + '</span><span class="rejected">‚ùå ' + rej + '</span><span class="total">(' + tasaSuc + '%)</span></div></div>';
    });
    
    const reclutadoras = ['Karla Flores', 'Yessica Huerta', 'Jezabel Monterrosas'];
    let recHTML = '';
    reclutadoras.forEach(rec => {
        const apr = aprobados.filter(r => r.reclutadora === rec).length;
        const rej = rechazados.filter(r => r.reclutadora === rec).length;
        const tot = apr + rej;
        const tasaRec = tot > 0 ? Math.round((apr/tot)*100) : 0;
        if (tot > 0) {
            recHTML += '<div class="breakdown-item"><span class="label">üë§ ' + rec + '</span><div class="values"><span class="approved">‚úÖ ' + apr + '</span><span class="rejected">‚ùå ' + rej + '</span><span class="total">(' + tasaRec + '%)</span></div></div>';
        }
    });
    
    let filtrosHTML = '';
    if (filtros.filtroSucursal || filtros.filtroReclutadora || filtros.filtroFuente || filtros.filtroPeriodo) {
        filtrosHTML = '<div class="active-filters">';
        if (filtros.filtroSucursal) filtrosHTML += '<span class="active-filter-tag">üìç ' + filtros.filtroSucursal + '</span>';
        if (filtros.filtroReclutadora) filtrosHTML += '<span class="active-filter-tag">üë§ ' + filtros.filtroReclutadora + '</span>';
        if (filtros.filtroFuente) filtrosHTML += '<span class="active-filter-tag">üì¢ ' + filtros.filtroFuente + '</span>';
        if (filtros.filtroPeriodo) {
            const txt = {hoy:'Hoy',semana:'Esta semana',mes:'Este mes'}[filtros.filtroPeriodo];
            if (txt) filtrosHTML += '<span class="active-filter-tag">‚è∞ ' + txt + '</span>';
        }
        filtrosHTML += '</div>';
    }
    
    const maxFunnel = Math.max(total, 1);
    const hTotal = Math.max(total / maxFunnel * 150, 50);
    const hApr = Math.max(totalApr / maxFunnel * 150, 40);
    const hET = Math.max(entrevistaTelAprobada / maxFunnel * 150, 35);
    const hPanel = Math.max(panelAprobado / maxFunnel * 150, 30);
    const hCap = Math.max(capacitacionConfirmada / maxFunnel * 150, 25);
    
    document.getElementById('content').innerHTML = filtrosHTML + 
        '<div class="stats-grid">' +
            '<div class="stat-card blue"><div class="stat-icon">üì•</div><div class="stat-number">' + total + '</div><div class="stat-label">Total Postulantes</div></div>' +
            '<div class="stat-card green"><div class="stat-icon">‚úÖ</div><div class="stat-number">' + totalApr + '</div><div class="stat-label">Aprobados Pre-Filtro</div></div>' +
            '<div class="stat-card red"><div class="stat-icon">‚ùå</div><div class="stat-number">' + totalRej + '</div><div class="stat-label">Rechazados Pre-Filtro</div></div>' +
            '<div class="stat-card purple"><div class="stat-icon">üìû</div><div class="stat-number">' + entrevistaTelAprobada + '</div><div class="stat-label">Entrev. Tel. Aprobadas</div></div>' +
        '</div>' +
        '<div class="funnel-card">' +
            '<h3>üéØ Embudo de Conversi√≥n</h3>' +
            '<div class="funnel-container">' +
                '<div class="funnel-stage"><div class="funnel-bar" style="height:' + hTotal + 'px">' + total + '</div><div class="funnel-label">Pre-Filtro</div><div class="funnel-pct">100%</div></div>' +
                '<div class="funnel-arrow">‚Üí</div>' +
                '<div class="funnel-stage"><div class="funnel-bar stage-2" style="height:' + hApr + 'px">' + totalApr + '</div><div class="funnel-label">Aprobados PF</div><div class="funnel-pct">' + tasa + '%</div></div>' +
                '<div class="funnel-arrow">‚Üí</div>' +
                '<div class="funnel-stage"><div class="funnel-bar stage-2" style="height:' + hET + 'px">' + entrevistaTelAprobada + '</div><div class="funnel-label">Entrev. Tel. ‚úì</div><div class="funnel-pct">' + (total > 0 ? Math.round((entrevistaTelAprobada/total)*100) : 0) + '%</div></div>' +
                '<div class="funnel-arrow">‚Üí</div>' +
                '<div class="funnel-stage"><div class="funnel-bar stage-3" style="height:' + hPanel + 'px">' + panelAprobado + '</div><div class="funnel-label">Panel ‚úì</div><div class="funnel-pct">' + (total > 0 ? Math.round((panelAprobado/total)*100) : 0) + '%</div></div>' +
                '<div class="funnel-arrow">‚Üí</div>' +
                '<div class="funnel-stage"><div class="funnel-bar stage-3" style="height:' + hCap + 'px">' + capacitacionConfirmada + '</div><div class="funnel-label">Capacitaci√≥n ‚úì</div><div class="funnel-pct">' + (total > 0 ? Math.round((capacitacionConfirmada/total)*100) : 0) + '%</div></div>' +
            '</div>' +
        '</div>' +
        '<div class="charts-grid">' +
            '<div class="chart-card"><h3>üìä Estado de Candidatos Pre-Filtro</h3><div class="chart-container"><canvas id="chart-estados-pf"></canvas></div></div>' +
            '<div class="chart-card"><h3>üìà Tasa de Aprobaci√≥n Pre-Filtro</h3><div style="padding: 40px 20px;"><div class="progress-container"><div class="progress-bar ' + progClass + '" style="width:' + Math.max(tasa,5) + '%">' + tasa + '%</div></div><div class="rate-legend"><span>0% - Baja</span><span>100% - Alta</span></div></div></div>' +
        '</div>' +
        '<div class="breakdown-grid">' +
            '<div class="breakdown-card"><h3>üè¢ Por Sucursal</h3>' + (sucHTML || '<div class="empty-state">Sin datos</div>') + '</div>' +
            '<div class="breakdown-card"><h3>üë§ Por Reclutadora</h3>' + (recHTML || '<div class="empty-state">Sin datos</div>') + '</div>' +
        '</div>';
    
    // Renderizar gr√°fica de estados
    setTimeout(function() {
        const ctx = document.getElementById('chart-estados-pf');
        if (ctx) {
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Nuevo', 'No Contest√≥', 'Entrev. Tel. Aprobada', 'Rechazado ET'],
                    datasets: [{
                        label: 'Candidatos',
                        data: [
                            conteoEstados['Nuevo'] || 0,
                            conteoEstados['No Contest√≥'] || 0,
                            conteoEstados['Entrevista Tel. Aprobada'] || 0,
                            conteoEstados['Rechazado ET'] || 0
                        ],
                        backgroundColor: ['#6366F1', '#F59E0B', '#10B981', '#EF4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
    }, 100);
}

function renderGraficas() {
    if (!datosGlobales) return;
    
    let aprobados = [...(datosGlobales.aprobados || [])];
    let rechazados = [...(datosGlobales.rechazados || [])];
    
    if (fechaCorte) {
        const corte = new Date(fechaCorte + 'T00:00:00');
        aprobados = aprobados.filter(r => new Date(r.fecha) >= corte);
        rechazados = rechazados.filter(r => new Date(r.fecha) >= corte);
    }
    
    const todos = [...aprobados, ...rechazados];
    
    document.getElementById('graficas-content').innerHTML = 
        '<div class="charts-grid">' +
            '<div class="chart-card"><h3>üì¢ Por Fuente de Contacto</h3><div class="chart-container"><canvas id="chart-fuente"></canvas></div></div>' +
            '<div class="chart-card"><h3>üí∞ Por Ingreso Esperado</h3><div class="chart-container"><canvas id="chart-ingreso"></canvas></div></div>' +
            '<div class="chart-card"><h3>üöó Por Tiempo de Traslado</h3><div class="chart-container"><canvas id="chart-traslado"></canvas></div></div>' +
            '<div class="chart-card"><h3>‚≠ê Por Clasificaci√≥n</h3><div class="chart-container"><canvas id="chart-clasificacion"></canvas></div></div>' +
            '<div class="chart-card"><h3>üè¢ Aprobados vs Rechazados por Sucursal</h3><div class="chart-container"><canvas id="chart-sucursal"></canvas></div></div>' +
            '<div class="chart-card"><h3>üìÖ Tendencia Semanal</h3><div class="chart-container"><canvas id="chart-semanal"></canvas></div></div>' +
        '</div>';
    
    Object.values(chartInstances).forEach(c => c.destroy());
    chartInstances = {};
    
    setTimeout(function() {
        // Por Fuente
        const fuenteData = {};
        todos.forEach(r => {
            const f = r.fuente || 'Sin especificar';
            fuenteData[f] = (fuenteData[f] || 0) + 1;
        });
        
        chartInstances.fuente = new Chart(document.getElementById('chart-fuente'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(fuenteData),
                datasets: [{ data: Object.values(fuenteData), backgroundColor: ['#00A8E1', '#8B5CF6', '#10B981', '#F59E0B', '#EF4444', '#EC4899'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });
        
        // Por Ingreso
        const ingresoData = {};
        todos.forEach(r => {
            const ing = r.ingresoEsperado || 'No especificado';
            ingresoData[ing] = (ingresoData[ing] || 0) + 1;
        });
        
        chartInstances.ingreso = new Chart(document.getElementById('chart-ingreso'), {
            type: 'bar',
            data: {
                labels: Object.keys(ingresoData),
                datasets: [{ label: 'Postulantes', data: Object.values(ingresoData), backgroundColor: '#00A8E1' }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
        
        // Por Traslado
        const trasladoData = {};
        todos.forEach(r => {
            const t = r.tiempoTraslado || 'No especificado';
            trasladoData[t] = (trasladoData[t] || 0) + 1;
        });
        
        chartInstances.traslado = new Chart(document.getElementById('chart-traslado'), {
            type: 'pie',
            data: {
                labels: Object.keys(trasladoData),
                datasets: [{ data: Object.values(trasladoData), backgroundColor: ['#10B981', '#F59E0B', '#EF4444', '#8B5CF6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });
        
        // Por Clasificaci√≥n
        const clasificacionData = { 'SOBRESALIENTE': 0, 'EXCELENTE': 0, 'MUY BUENO': 0 };
        todos.forEach(r => {
            const c = r.clasificacion || '';
            if (c.includes('SOBRESALIENTE')) clasificacionData['SOBRESALIENTE']++;
            else if (c.includes('EXCELENTE')) clasificacionData['EXCELENTE']++;
            else if (c.includes('MUY BUENO') || c.includes('BUENO')) clasificacionData['MUY BUENO']++;
        });
        
        chartInstances.clasificacion = new Chart(document.getElementById('chart-clasificacion'), {
            type: 'doughnut',
            data: {
                labels: ['üåü Sobresaliente', '‚≠ê Excelente', '‚úÖ Muy Bueno'],
                datasets: [{ data: Object.values(clasificacionData), backgroundColor: ['#10B981', '#F59E0B', '#EF4444'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });
        
        // Por Sucursal
        const sucursales = ['Torre JV Ju√°rez', 'Edificio Inbursa Antequera'];
        chartInstances.sucursal = new Chart(document.getElementById('chart-sucursal'), {
            type: 'bar',
            data: {
                labels: ['Torre JV', 'Inbursa'],
                datasets: [
                    { label: 'Aprobados', data: sucursales.map(s => aprobados.filter(r => r.sucursal === s).length), backgroundColor: '#10B981' },
                    { label: 'Rechazados', data: sucursales.map(s => rechazados.filter(r => r.sucursal === s).length), backgroundColor: '#EF4444' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
        
        // Tendencia Semanal
        const semanas = {};
        const hoy = new Date();
        for (let i = 3; i >= 0; i--) {
            const fin = new Date(hoy); fin.setDate(hoy.getDate() - (i * 7));
            const inicio = new Date(fin); inicio.setDate(fin.getDate() - 6);
            const label = i === 0 ? 'Esta sem.' : i === 1 ? 'Sem. pasada' : 'Hace ' + i + ' sem.';
            semanas[label] = {
                apr: aprobados.filter(r => { const f = new Date(r.fecha); return f >= inicio && f <= fin; }).length,
                rej: rechazados.filter(r => { const f = new Date(r.fecha); return f >= inicio && f <= fin; }).length
            };
        }
        
        chartInstances.semanal = new Chart(document.getElementById('chart-semanal'), {
            type: 'line',
            data: {
                labels: Object.keys(semanas),
                datasets: [
                    { label: 'Aprobados', data: Object.values(semanas).map(v => v.apr), borderColor: '#10B981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.4 },
                    { label: 'Rechazados', data: Object.values(semanas).map(v => v.rej), borderColor: '#EF4444', backgroundColor: 'rgba(239,68,68,0.1)', fill: true, tension: 0.4 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
        });
    }, 100);
}

function actualizarOpcionesComparacion() {
    const tipo = document.getElementById('compare-tipo').value;
    const selectA = document.getElementById('compare-a');
    const selectB = document.getElementById('compare-b');
    
    let opciones = [];
    if (tipo === 'sucursal') {
        opciones = [{v:'Torre JV Ju√°rez',t:'üè¢ Torre JV'},{v:'Edificio Inbursa Antequera',t:'üèõÔ∏è Inbursa'}];
    } else if (tipo === 'reclutadora') {
        opciones = [{v:'Karla Flores',t:'üë§ Karla Flores'},{v:'Yessica Huerta',t:'üë§ Yessica Huerta'},{v:'Jezabel Monterrosas',t:'üë§ Jezabel Monterrosas'}];
    } else if (tipo === 'fuente') {
        const fuentes = new Set();
        if (datosGlobales) {
            [...(datosGlobales.aprobados || []), ...(datosGlobales.rechazados || [])].forEach(r => {
                if (r.fuente) fuentes.add(r.fuente);
            });
        }
        opciones = [...fuentes].map(f => ({v: f, t: 'üì¢ ' + f}));
    }
    
    selectA.innerHTML = opciones.map(o => '<option value="' + o.v + '">' + o.t + '</option>').join('');
    selectB.innerHTML = opciones.map(o => '<option value="' + o.v + '">' + o.t + '</option>').join('');
    if (opciones.length > 1) selectB.selectedIndex = 1;
}

function ejecutarComparacion() {
    if (!datosGlobales) return;
    
    const tipo = document.getElementById('compare-tipo').value;
    const valorA = document.getElementById('compare-a').value;
    const valorB = document.getElementById('compare-b').value;
    const textoA = document.getElementById('compare-a').options[document.getElementById('compare-a').selectedIndex].text;
    const textoB = document.getElementById('compare-b').options[document.getElementById('compare-b').selectedIndex].text;
    
    let aprobados = datosGlobales.aprobados || [];
    let rechazados = datosGlobales.rechazados || [];
    
    if (fechaCorte) {
        const corte = new Date(fechaCorte + 'T00:00:00');
        aprobados = aprobados.filter(r => new Date(r.fecha) >= corte);
        rechazados = rechazados.filter(r => new Date(r.fecha) >= corte);
    }
    
    const campo = tipo === 'sucursal' ? 'sucursal' : tipo === 'reclutadora' ? 'reclutadora' : 'fuente';
    
    const aprA = aprobados.filter(r => r[campo] === valorA).length;
    const rejA = rechazados.filter(r => r[campo] === valorA).length;
    const totalA = aprA + rejA;
    const tasaA = totalA > 0 ? Math.round((aprA / totalA) * 100) : 0;
    
    const aprB = aprobados.filter(r => r[campo] === valorB).length;
    const rejB = rechazados.filter(r => r[campo] === valorB).length;
    const totalB = aprB + rejB;
    const tasaB = totalB > 0 ? Math.round((aprB / totalB) * 100) : 0;
    
    let ganador = tasaA > tasaB ? 'A' : tasaB > tasaA ? 'B' : '';
    
    document.getElementById('compare-results').innerHTML = 
        '<div class="compare-results">' +
            '<div class="compare-card left"><h4>' + textoA + '</h4>' +
                '<div class="compare-stat"><div class="number">' + totalA + '</div><div class="label">Total</div></div>' +
                '<div class="compare-stat"><div class="number">' + aprA + '</div><div class="label">Aprobados</div></div>' +
                '<div class="compare-stat"><div class="number">' + tasaA + '%</div><div class="label">Tasa</div></div>' +
                (ganador === 'A' ? '<div class="winner-badge">üèÜ MEJOR</div>' : '') +
            '</div>' +
            '<div class="compare-vs"><div class="vs">VS</div><div style="margin-top:15px;font-size:13px;color:var(--gray-500)">Diferencia: <strong>' + Math.abs(tasaA - tasaB) + '%</strong></div></div>' +
            '<div class="compare-card right"><h4>' + textoB + '</h4>' +
                '<div class="compare-stat"><div class="number">' + totalB + '</div><div class="label">Total</div></div>' +
                '<div class="compare-stat"><div class="number">' + aprB + '</div><div class="label">Aprobados</div></div>' +
                '<div class="compare-stat"><div class="number">' + tasaB + '%</div><div class="label">Tasa</div></div>' +
                (ganador === 'B' ? '<div class="winner-badge">üèÜ MEJOR</div>' : '') +
            '</div>' +
        '</div>';
}

function iniciarAutoRefresh() {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    autoRefreshInterval = setInterval(function() {
        cargarEstadisticas(false);
    }, 60000);
}

document.addEventListener('DOMContentLoaded', function() {
    actualizarBadgeFechaCorte();
    cargarEstadisticas();
    iniciarAutoRefresh();
});
    </script>
</body>
</html>
