<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Resultados Panel | AT&T - ExpertCell</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --att-blue: #00A8E1; --att-blue-dark: #0057B8; --att-blue-deeper: #003A70;
            --white: #FFFFFF; --gray-50: #F8FAFC; --gray-100: #F1F5F9; --gray-200: #E2E8F0;
            --gray-300: #CBD5E1; --gray-400: #94A3B8; --gray-500: #64748B; --gray-600: #475569;
            --gray-700: #334155; --gray-800: #1E293B;
            --success: #10B981; --success-light: #D1FAE5;
            --warning: #F59E0B; --warning-light: #FEF3C7;
            --danger: #EF4444; --danger-light: #FEE2E2;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans', sans-serif; background: linear-gradient(135deg, var(--gray-100) 0%, var(--gray-200) 100%); min-height: 100vh; color: var(--gray-800); }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: url('https://jonathanatenorio-hue.github.io/formulario-att-v2/logo-att.png') center center / cover no-repeat; padding: 30px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 10px 40px rgba(0, 87, 184, 0.3); position: relative; overflow: hidden; min-height: 140px; }
        .header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to right, rgba(0, 58, 112, 0.95) 0%, rgba(0, 58, 112, 0.5) 50%, transparent 100%); }
        .header-content { display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1; min-height: 80px; flex-wrap: wrap; gap: 20px; }
        .header-text h1 { color: var(--white); font-size: 26px; font-weight: 700; margin-bottom: 4px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header-text p { color: rgba(255,255,255,0.9); font-size: 14px; }
        .header-badge { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; color: white; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .live-dot { width: 8px; height: 8px; background: #10B981; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .main-tabs { display: flex; gap: 8px; margin-bottom: 24px; }
        .main-tab { padding: 14px 28px; border: 2px solid var(--gray-200); border-radius: 12px; background: var(--white); font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; font-family: inherit; }
        .main-tab:hover { border-color: var(--att-blue); }
        .main-tab.active { background: linear-gradient(135deg, var(--att-blue) 0%, var(--att-blue-dark) 100%); border-color: var(--att-blue); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--white); border-radius: 14px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid var(--gray-200); text-align: center; }
        .stat-card.blue { border-left: 4px solid var(--att-blue); }
        .stat-card.green { border-left: 4px solid var(--success); }
        .stat-card.yellow { border-left: 4px solid var(--warning); }
        .stat-card.red { border-left: 4px solid var(--danger); }
        .stat-card.gray { border-left: 4px solid var(--gray-400); }
        .stat-card.purple { border-left: 4px solid #8B5CF6; }
        .stat-number { font-size: 36px; font-weight: 700; margin-bottom: 4px; }
        .stat-card.blue .stat-number { color: var(--att-blue); }
        .stat-card.green .stat-number { color: var(--success); }
        .stat-card.yellow .stat-number { color: var(--warning); }
        .stat-card.red .stat-number { color: var(--danger); }
        .stat-card.gray .stat-number { color: var(--gray-500); }
        .stat-card.purple .stat-number { color: #8B5CF6; }
        .stat-label { font-size: 13px; color: var(--gray-500); font-weight: 500; }
        .filters { display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-group label { font-size: 14px; font-weight: 500; color: var(--gray-600); }
        .filter-group select { padding: 10px 16px; border: 2px solid var(--gray-200); border-radius: 10px; font-size: 14px; font-family: inherit; background: var(--white); min-width: 180px; }
        .filter-group select:focus { outline: none; border-color: var(--att-blue); }
        .btn { padding: 10px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; font-family: inherit; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-primary { background: linear-gradient(135deg, var(--att-blue) 0%, var(--att-blue-dark) 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,168,225,0.3); }
        .card { background: var(--white); border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); border: 1px solid var(--gray-200); margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
        .card-title { font-size: 18px; font-weight: 600; color: var(--gray-800); display: flex; align-items: center; gap: 10px; }
        .results-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .results-table th { text-align: left; padding: 14px 12px; background: var(--gray-50); color: var(--gray-600); font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--gray-200); }
        .results-table td { padding: 14px 12px; border-bottom: 1px solid var(--gray-100); vertical-align: middle; }
        .results-table tr:hover { background: var(--gray-50); }
        .aspirante-info { display: flex; align-items: center; gap: 12px; }
        .aspirante-avatar { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; color: white; background: linear-gradient(135deg, var(--att-blue) 0%, var(--att-blue-dark) 100%); }
        .aspirante-name { font-weight: 600; color: var(--gray-800); }
        .aspirante-hora { font-size: 12px; color: var(--gray-500); }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .badge-success { background: var(--success-light); color: #065F46; }
        .badge-warning { background: var(--warning-light); color: #92400E; }
        .badge-danger { background: var(--danger-light); color: #991B1B; }
        .badge-gray { background: var(--gray-100); color: var(--gray-600); }
        .badge-purple { background: #EDE9FE; color: #6D28D9; }
        .puntaje { font-size: 18px; font-weight: 700; }
        .puntaje.high { color: var(--success); }
        .puntaje.medium { color: var(--warning); }
        .puntaje.low { color: var(--danger); }
        .status-cell { text-align: center; }
        .docs-progress { display: flex; align-items: center; gap: 8px; }
        .docs-bar { width: 60px; height: 6px; background: var(--gray-200); border-radius: 3px; overflow: hidden; }
        .docs-bar-fill { height: 100%; background: var(--success); transition: width 0.3s; }
        .docs-text { font-size: 12px; color: var(--gray-500); }
        .action-btn { padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; gap: 4px; }
        .action-btn.send { background: var(--att-blue); color: white; }
        .action-btn.send:hover { background: var(--att-blue-dark); }
        .action-btn.sent { background: var(--gray-100); color: var(--gray-500); cursor: default; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state .icon { font-size: 64px; margin-bottom: 16px; }
        .empty-state h3 { color: var(--gray-700); margin-bottom: 8px; }
        .empty-state p { color: var(--gray-500); }
        .loading { display: inline-block; width: 18px; height: 18px; border: 2px solid var(--gray-200); border-radius: 50%; border-top-color: var(--att-blue); animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 16px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 18px; color: var(--gray-800); }
        .modal-close { background: none; border: none; font-size: 24px; color: var(--gray-400); cursor: pointer; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 12px; flex-wrap: wrap; }
        .btn-success { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); color: white; }
        .analytics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .analytics-card { background: var(--white); border-radius: 14px; padding: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid var(--gray-200); }
        .analytics-card.full-width { grid-column: span 2; }
        .analytics-card h3 { font-size: 14px; color: var(--gray-500); font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .analytics-big-number { font-size: 48px; font-weight: 700; color: var(--att-blue); }
        .analytics-subtitle { font-size: 14px; color: var(--gray-500); margin-top: 4px; }
        .analytics-trend { display: flex; align-items: center; gap: 6px; font-size: 13px; margin-top: 8px; }
        .analytics-trend.up { color: var(--success); }
        .analytics-trend.down { color: var(--danger); }
        .chart-container { position: relative; height: 250px; }
        .chart-container-small { position: relative; height: 200px; }
        .ranking-list { list-style: none; }
        .ranking-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--gray-100); }
        .ranking-item:last-child { border-bottom: none; }
        .ranking-position { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; margin-right: 12px; }
        .ranking-position.gold { background: #FEF3C7; color: #92400E; }
        .ranking-position.silver { background: var(--gray-200); color: var(--gray-600); }
        .ranking-position.bronze { background: #FED7AA; color: #9A3412; }
        .ranking-position.normal { background: var(--gray-100); color: var(--gray-500); }
        .ranking-info { flex: 1; }
        .ranking-name { font-weight: 600; color: var(--gray-800); font-size: 14px; }
        .ranking-detail { font-size: 12px; color: var(--gray-500); }
        .ranking-value { font-weight: 700; color: var(--att-blue); font-size: 16px; }
        .kpi-row { display: flex; gap: 24px; margin-top: 16px; }
        .kpi-item { flex: 1; text-align: center; padding: 16px; background: var(--gray-50); border-radius: 10px; }
        .kpi-value { font-size: 24px; font-weight: 700; color: var(--gray-800); }
        .kpi-label { font-size: 12px; color: var(--gray-500); margin-top: 4px; }
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } .analytics-grid { grid-template-columns: repeat(2, 1fr); } .analytics-card.full-width { grid-column: span 2; } }
        @media (max-width: 768px) { .container { padding: 12px; } .stats-grid { grid-template-columns: repeat(2, 1fr); } .analytics-grid { grid-template-columns: 1fr; } .analytics-card.full-width { grid-column: span 1; } .filters { flex-direction: column; align-items: stretch; } .filter-group select { width: 100%; } .results-table { font-size: 12px; } .hide-mobile { display: none; } .modal-footer { flex-direction: column; } .modal-footer .btn { width: 100%; justify-content: center; } .main-tabs { flex-direction: column; } .kpi-row { flex-direction: column; gap: 12px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1>üìä Dashboard Resultados Panel</h1>
                    <p>Seguimiento de evaluaciones y contrataciones</p>
                </div>
                <div class="header-badge">
                    <span class="live-dot"></span>
                    <span id="last-update">Actualizaci√≥n autom√°tica</span>
                </div>
            </div>
        </div>
        <div class="main-tabs">
            <button class="main-tab active" onclick="showMainTab('resultados')">üìã Resultados del Panel</button>
            <button class="main-tab" onclick="showMainTab('analytics')">üìà Analytics & Estad√≠sticas</button>
        </div>
        <div class="tab-content active" id="tab-resultados">
            <div class="stats-grid">
                <div class="stat-card blue"><div class="stat-number" id="stat-total">0</div><div class="stat-label">Total Evaluados</div></div>
                <div class="stat-card green"><div class="stat-number" id="stat-aprobados">0</div><div class="stat-label">‚úÖ Aprobados</div></div>
                <div class="stat-card yellow"><div class="stat-number" id="stat-regulares">0</div><div class="stat-label">‚ö†Ô∏è Regulares</div></div>
                <div class="stat-card red"><div class="stat-number" id="stat-rechazados">0</div><div class="stat-label">‚ùå Rechazados</div></div>
                <div class="stat-card purple"><div class="stat-number" id="stat-listos">0</div><div class="stat-label">üéØ Listos</div></div>
                <div class="stat-card gray"><div class="stat-number" id="stat-confirmados">0</div><div class="stat-label">üìã Confirmados</div></div>
            </div>
            <div class="filters">
                <div class="filter-group"><label>üìÖ Fecha:</label><select id="select-fecha" onchange="cargarResultados()"><option value="">Selecciona fecha</option></select></div>
                <div class="filter-group"><label>üìç Sucursal:</label><select id="select-sucursal" onchange="cargarResultados()"><option value="">Todas</option><option value="Torre JV Ju√°rez">Torre JV Ju√°rez</option><option value="Edificio Inbursa Antequera">Edificio Inbursa Antequera</option></select></div>
                <div class="filter-group"><label>üéØ Estado:</label><select id="select-estado" onchange="filtrarResultados()"><option value="todos">üìä Todos</option><option value="listo">‚úÖ Listos para capacitar</option><option value="pendiente">‚è≥ Pendientes</option><option value="rechazado">‚ùå Rechazados</option><option value="no_show">üö´ No se presentaron</option></select></div>
                <button class="btn btn-primary" onclick="cargarResultados()">üîÑ Actualizar</button>
            </div>
            <div class="card"><div class="card-header"><div class="card-title">üìã Resultados del Panel</div></div><div id="results-container"><div class="empty-state"><div class="icon">üìÖ</div><h3>Selecciona una fecha</h3><p>Elige una fecha de panel para ver los resultados</p></div></div></div>
        </div>
        <div class="tab-content" id="tab-analytics">
            <div class="filters">
                <div class="filter-group"><label>üìç Sucursal:</label><select id="analytics-sucursal" onchange="cargarAnalytics()"><option value="">Todas las sucursales</option><option value="Torre JV Ju√°rez">Torre JV Ju√°rez</option><option value="Edificio Inbursa Antequera">Edificio Inbursa Antequera</option></select></div>
                <div class="filter-group"><label>üìÖ Per√≠odo:</label><select id="analytics-periodo" onchange="cargarAnalytics()"><option value="mes">√öltimo mes</option><option value="trimestre">√öltimo trimestre</option><option value="semestre">√öltimo semestre</option><option value="anio">√öltimo a√±o</option></select></div>
                <button class="btn btn-primary" onclick="cargarAnalytics()">üîÑ Actualizar</button>
            </div>
            <div class="analytics-grid">
                <div class="analytics-card"><h3>üë• Total Evaluados</h3><div class="analytics-big-number" id="analytics-total">0</div><div class="analytics-subtitle">en el per√≠odo seleccionado</div><div class="analytics-trend up" id="analytics-total-trend"><span>‚Üë</span> <span>vs per√≠odo anterior</span></div></div>
                <div class="analytics-card"><h3>‚úÖ Tasa de Aprobaci√≥n</h3><div class="analytics-big-number" id="analytics-tasa" style="color: var(--success);">0%</div><div class="analytics-subtitle">aprobados del total</div><div class="analytics-trend up" id="analytics-tasa-trend"><span>‚Üë</span> <span>vs per√≠odo anterior</span></div></div>
                <div class="analytics-card"><h3>üéØ Tasa de Conversi√≥n</h3><div class="analytics-big-number" id="analytics-conversion" style="color: #8B5CF6;">0%</div><div class="analytics-subtitle">listos para capacitar</div><div class="analytics-trend up" id="analytics-conversion-trend"><span>‚Üë</span> <span>vs per√≠odo anterior</span></div></div>
                <div class="analytics-card"><h3>üìä Puntaje Promedio</h3><div class="analytics-big-number" id="analytics-puntaje" style="color: var(--warning);">0</div><div class="analytics-subtitle">de 80 puntos posibles</div><div class="analytics-trend up" id="analytics-puntaje-trend"><span>‚Üë</span> <span>vs per√≠odo anterior</span></div></div>
                <div class="analytics-card full-width"><h3>üìà Aprobados por Semana</h3><div class="chart-container"><canvas id="chart-semanal"></canvas></div></div>
                <div class="analytics-card"><h3>üéØ Distribuci√≥n de Resultados</h3><div class="chart-container-small"><canvas id="chart-resultados"></canvas></div></div>
                <div class="analytics-card"><h3>üìç Comparativa por Sucursal</h3><div class="chart-container-small"><canvas id="chart-sucursales"></canvas></div></div>
                <div class="analytics-card"><h3>üèÜ Top Reclutadores</h3><ul class="ranking-list" id="ranking-reclutadores"><li class="ranking-item"><span class="ranking-position gold">1</span><div class="ranking-info"><div class="ranking-name">Cargando...</div><div class="ranking-detail">-</div></div><span class="ranking-value">-</span></li></ul></div>
                <div class="analytics-card"><h3>üìä M√©tricas de Proceso</h3><div class="kpi-row"><div class="kpi-item"><div class="kpi-value" id="kpi-noshow">0%</div><div class="kpi-label">No Show</div></div><div class="kpi-item"><div class="kpi-value" id="kpi-confirmacion">0%</div><div class="kpi-label">Confirmaci√≥n</div></div></div><div class="kpi-row" style="margin-top: 12px;"><div class="kpi-item"><div class="kpi-value" id="kpi-docs">0%</div><div class="kpi-label">Docs Completos</div></div><div class="kpi-item"><div class="kpi-value" id="kpi-psico">0%</div><div class="kpi-label">Psicom√©tricos</div></div></div></div>
                <div class="analytics-card full-width"><h3>üìÖ Hist√≥rico Mensual</h3><div class="chart-container"><canvas id="chart-mensual"></canvas></div></div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="modal-envio">
        <div class="modal">
            <div class="modal-header"><h3>üìß Enviar Felicitaci√≥n</h3><button class="modal-close" onclick="cerrarModal()">&times;</button></div>
            <div class="modal-body">
                <p style="margin-bottom: 16px;">¬øDeseas enviar el email de felicitaci√≥n con feedback a:</p>
                <div style="background: var(--gray-50); padding: 16px; border-radius: 10px; margin-bottom: 16px;"><strong id="modal-nombre">Nombre del aspirante</strong><p style="font-size: 13px; color: var(--gray-500); margin-top: 4px;" id="modal-info">Sucursal ‚Ä¢ Puntaje</p></div>
                <div id="modal-docs-pendientes"></div>
                <p style="font-size: 13px; color: var(--gray-500);">El email incluir√°:</p>
                <ul style="font-size: 13px; color: var(--gray-500); margin: 8px 0 0 20px;"><li>Felicitaci√≥n personalizada</li><li>Puntaje y resultado</li><li>Fortalezas detectadas</li><li>√Åreas de oportunidad</li><li>Documentos pendientes (si hay)</li><li>Fecha y hora de capacitaci√≥n (9:50 AM)</li><li>Bot√≥n para confirmar asistencia</li></ul>
            </div>
            <div class="modal-footer">
                <button class="btn" style="background: var(--gray-100); color: var(--gray-700);" onclick="cerrarModal()">Cancelar</button>
                <button class="btn btn-success" id="btn-confirmar-envio" onclick="confirmarEnvio()">üìß Enviar Email</button>
                <button class="btn btn-primary" id="btn-descargar-imagen" onclick="descargarImagen()">üì± Descargar WhatsApp</button>
            </div>
        </div>
    </div>
    <script>
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby-HOsviZvkv83Lrsu6cFukqRK6uuft9nw438lxPv2WOX_prRx3CfosVF7-BxuwBJCQ9A/exec';
let resultadosData = [], resultadosFiltrados = [], aspiranteSeleccionado = null;
let chartSemanal, chartResultados, chartSucursales, chartMensual;

document.addEventListener('DOMContentLoaded', () => { cargarFechas(); setInterval(() => { if (document.getElementById('select-fecha').value) cargarResultados(true); }, 30000); });

function showMainTab(tab) {
    document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector(`[onclick="showMainTab('${tab}')"]`).classList.add('active');
    document.getElementById('tab-' + tab).classList.add('active');
    if (tab === 'analytics') cargarAnalytics();
}

async function cargarFechas() {
    const select = document.getElementById('select-fecha');
    try {
        const r = await fetch(GOOGLE_SCRIPT_URL + '?action=getFechasPanel');
        const data = await r.json();
        select.innerHTML = '<option value="">Selecciona fecha</option>';
        if (data.fechas && data.fechas.length > 0) {
            data.fechas.forEach(f => { const opt = document.createElement('option'); opt.value = f.fecha; opt.textContent = f.fechaLegible; if (f.esHoy) opt.selected = true; select.appendChild(opt); });
            if (select.value) cargarResultados();
        }
    } catch (e) { console.error(e); }
}

function estaListo(r) {
    const esAprobado = r.resultado === 'Aprobado (muy bien)' || r.resultado === 'Aprobado (regular)';
    return esAprobado && r.checklistCompleto === true && r.psicometricos === true && r.felicitacionEnviada === true;
}

function obtenerEstadoGeneral(r) {
    if (r.resultado === 'No se present√≥') return 'no_show';
    if (r.resultado && r.resultado.includes('No aprob√≥')) return 'rechazado';
    if (estaListo(r)) return 'listo';
    if (r.resultado === 'Aprobado (muy bien)' || r.resultado === 'Aprobado (regular)') return 'pendiente';
    return 'sin_evaluar';
}

function filtrarResultados() {
    const estadoFiltro = document.getElementById('select-estado').value;
    if (estadoFiltro === 'todos' || !estadoFiltro) { resultadosFiltrados = [...resultadosData]; }
    else { resultadosFiltrados = resultadosData.filter(r => obtenerEstadoGeneral(r) === estadoFiltro); }
    renderizarTabla();
}

async function cargarResultados(silencioso = false) {
    const fecha = document.getElementById('select-fecha').value;
    const sucursal = document.getElementById('select-sucursal').value;
    if (!fecha) return;
    const container = document.getElementById('results-container');
    if (!silencioso) container.innerHTML = '<div style="text-align:center;padding:40px;"><span class="loading"></span></div>';
    try {
        const url = GOOGLE_SCRIPT_URL + '?action=getResultadosConChecklist&fecha=' + encodeURIComponent(fecha) + '&sucursal=' + encodeURIComponent(sucursal);
        const r = await fetch(url);
        const data = await r.json();
        resultadosData = data.resultados || [];
        document.getElementById('stat-total').textContent = data.stats?.total || 0;
        document.getElementById('stat-aprobados').textContent = data.stats?.aprobados || 0;
        document.getElementById('stat-regulares').textContent = data.stats?.regulares || 0;
        document.getElementById('stat-rechazados').textContent = data.stats?.rechazados || 0;
        document.getElementById('stat-listos').textContent = resultadosData.filter(r => estaListo(r)).length;
        document.getElementById('stat-confirmados').textContent = resultadosData.filter(r => r.confirmacionAsistencia === 'Confirmado').length;
        document.getElementById('last-update').textContent = 'Actualizado: ' + new Date().toLocaleTimeString('es-MX');
        filtrarResultados();
    } catch (e) { console.error(e); container.innerHTML = '<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><h3>Error al cargar</h3><p>Intenta de nuevo</p></div>'; }
}

function renderizarTabla() {
    const container = document.getElementById('results-container');
    if (resultadosFiltrados.length === 0) { container.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><h3>Sin resultados</h3><p>No hay evaluaciones que coincidan con los filtros</p></div>'; return; }
    let html = `<table class="results-table"><thead><tr><th>Aspirante</th><th class="hide-mobile">Sucursal</th><th style="text-align:center;">Puntaje</th><th style="text-align:center;">Resultado</th><th style="text-align:center;">Docs</th><th style="text-align:center;">Psico</th><th style="text-align:center;">Email</th><th style="text-align:center;">Confirm√≥</th><th style="text-align:center;">Listo</th><th style="text-align:center;">Acci√≥n</th></tr></thead><tbody>`;
    resultadosFiltrados.forEach((r, idx) => {
        const realIdx = resultadosData.findIndex(item => item.nombre === r.nombre && item.hora === r.hora);
        const iniciales = r.nombre.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
        let puntajeClass = r.puntaje >= 64 ? 'high' : r.puntaje >= 48 ? 'medium' : 'low';
        let resultadoBadge = '<span class="badge badge-gray">‚è≥ Pendiente</span>';
        if (r.resultado === 'Aprobado (muy bien)') resultadoBadge = '<span class="badge badge-success">‚úÖ Muy bien</span>';
        else if (r.resultado === 'Aprobado (regular)') resultadoBadge = '<span class="badge badge-warning">‚ö†Ô∏è Regular</span>';
        else if (r.resultado && r.resultado.includes('No aprob√≥')) resultadoBadge = '<span class="badge badge-danger">‚ùå No aprob√≥</span>';
        else if (r.resultado === 'No se present√≥') resultadoBadge = '<span class="badge badge-gray">üö´ No show</span>';
        const docsTotal = 12, docsOk = r.docsOk || 0, docsPercent = Math.round((docsOk / docsTotal) * 100);
        let docsHTML = r.checklistCompleto ? '<span style="color: var(--success); font-size: 18px;">‚úÖ</span>' : r.tieneChecklist ? `<div class="docs-progress"><div class="docs-bar"><div class="docs-bar-fill" style="width:${docsPercent}%"></div></div><span class="docs-text">${docsOk}/${docsTotal}</span></div>` : '<span class="badge badge-gray">Sin llenar</span>';
        let psicoHTML = r.psicometricos === true ? '<span style="color: var(--success); font-size: 18px;">‚úÖ</span>' : (r.tieneChecklist && r.psicometricos === false) ? '<span style="color: var(--danger); font-size: 18px;">‚ùå</span>' : '<span style="color: var(--gray-400); font-size: 18px;">‚è≥</span>';
        let emailHTML = r.felicitacionEnviada ? '<span style="color: var(--success); font-size: 18px;">‚úÖ</span>' : '<span style="color: var(--gray-400); font-size: 18px;">‚è≥</span>';
        let confirmoHTML = r.confirmacionAsistencia === 'Confirmado' ? '<span class="badge badge-success">‚úÖ S√≠</span>' : r.felicitacionEnviada ? '<span class="badge badge-warning">‚è≥ Pendiente</span>' : '<span class="badge badge-gray">-</span>';
        let listoHTML = estaListo(r) ? '<span class="badge badge-purple">üéØ Listo</span>' : (r.resultado === 'Aprobado (muy bien)' || r.resultado === 'Aprobado (regular)') ? '<span class="badge badge-warning">‚è≥ Pendiente</span>' : (r.resultado && (r.resultado.includes('No aprob√≥') || r.resultado === 'No se present√≥')) ? '<span class="badge badge-danger">‚ùå No</span>' : '<span class="badge badge-gray">-</span>';
        let accionHTML = '-';
        const esAprobado = r.resultado === 'Aprobado (muy bien)' || r.resultado === 'Aprobado (regular)';
        if (esAprobado && !r.felicitacionEnviada) { accionHTML = r.checklistCompleto ? `<button class="action-btn send" onclick="abrirModalEnvio(${realIdx})">üìß Enviar</button>` : r.tieneChecklist ? `<button class="action-btn send" onclick="abrirModalEnvio(${realIdx})" style="background:var(--warning);">‚ö†Ô∏è Enviar</button>` : '<span class="badge badge-gray">Falta checklist</span>'; }
        else if (esAprobado && r.felicitacionEnviada) { accionHTML = '<button class="action-btn sent" disabled>‚úÖ Enviado</button>'; }
        html += `<tr><td><div class="aspirante-info"><div class="aspirante-avatar">${iniciales}</div><div><div class="aspirante-name">${r.nombre}</div><div class="aspirante-hora">üïê ${r.hora}</div></div></div></td><td class="hide-mobile">${r.sucursal}</td><td style="text-align:center;"><span class="puntaje ${puntajeClass}">${r.puntaje || '-'}</span></td><td style="text-align:center;">${resultadoBadge}</td><td style="text-align:center;">${docsHTML}</td><td class="status-cell">${psicoHTML}</td><td class="status-cell">${emailHTML}</td><td style="text-align:center;">${confirmoHTML}</td><td style="text-align:center;">${listoHTML}</td><td style="text-align:center;">${accionHTML}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
}

async function cargarAnalytics() {
    const sucursal = document.getElementById('analytics-sucursal').value;
    const periodo = document.getElementById('analytics-periodo').value;
    try {
        const url = GOOGLE_SCRIPT_URL + '?action=getAnalyticsDashboard&sucursal=' + encodeURIComponent(sucursal) + '&periodo=' + encodeURIComponent(periodo);
        const r = await fetch(url);
        const data = await r.json();
        if (data.status === 'success') { actualizarKPIs(data); actualizarGraficas(data); actualizarRanking(data); }
        else { usarDatosDemo(); }
    } catch (e) { console.error('Error cargando analytics:', e); usarDatosDemo(); }
}

function usarDatosDemo() {
    const demoData = { total: 127, aprobados: 89, rechazados: 25, noShow: 13, puntajePromedio: 62, tasaAprobacion: 70, tasaConversion: 58, tasaNoShow: 10, tasaConfirmacion: 82, tasaDocs: 75, tasaPsico: 88, muyBien: 55, regular: 34,
        semanal: { labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'], aprobados: [18, 22, 25, 24], rechazados: [5, 7, 6, 7], noShow: [3, 2, 4, 4] },
        mensual: { labels: ['Sep', 'Oct', 'Nov', 'Dic', 'Ene'], aprobados: [65, 78, 82, 89, 94], total: [95, 110, 115, 120, 127] },
        sucursales: { labels: ['Torre JV Ju√°rez', 'Edificio Inbursa'], aprobados: [52, 37], total: [72, 55] },
        reclutadores: [ { nombre: 'Karla Flores', sucursal: 'Torre JV Ju√°rez', aprobados: 32 }, { nombre: 'Yessica Huerta', sucursal: 'Edificio Inbursa', aprobados: 28 }, { nombre: 'Jezabel Monterrosas', sucursal: 'Edificio Inbursa', aprobados: 21 } ]
    };
    actualizarKPIs(demoData); actualizarGraficas(demoData); actualizarRanking(demoData);
}

function actualizarKPIs(data) {
    document.getElementById('analytics-total').textContent = data.total || 0;
    document.getElementById('analytics-tasa').textContent = (data.tasaAprobacion || 0) + '%';
    document.getElementById('analytics-conversion').textContent = (data.tasaConversion || 0) + '%';
    document.getElementById('analytics-puntaje').textContent = data.puntajePromedio || 0;
    document.getElementById('kpi-noshow').textContent = (data.tasaNoShow || 0) + '%';
    document.getElementById('kpi-confirmacion').textContent = (data.tasaConfirmacion || 0) + '%';
    document.getElementById('kpi-docs').textContent = (data.tasaDocs || 0) + '%';
    document.getElementById('kpi-psico').textContent = (data.tasaPsico || 0) + '%';
}

function actualizarGraficas(data) {
    if (chartSemanal) chartSemanal.destroy();
    chartSemanal = new Chart(document.getElementById('chart-semanal').getContext('2d'), { type: 'line', data: { labels: data.semanal?.labels || ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'], datasets: [{ label: 'Aprobados', data: data.semanal?.aprobados || [18, 22, 25, 24], borderColor: '#10B981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4 }, { label: 'Rechazados', data: data.semanal?.rechazados || [5, 7, 6, 7], borderColor: '#EF4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.4 }, { label: 'No Show', data: data.semanal?.noShow || [3, 2, 4, 4], borderColor: '#94A3B8', backgroundColor: 'rgba(148, 163, 184, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } } });
    if (chartResultados) chartResultados.destroy();
    chartResultados = new Chart(document.getElementById('chart-resultados').getContext('2d'), { type: 'doughnut', data: { labels: ['Muy bien', 'Regular', 'Rechazados', 'No Show'], datasets: [{ data: [data.muyBien || 55, data.regular || 34, data.rechazados || 25, data.noShow || 13], backgroundColor: ['#10B981', '#F59E0B', '#EF4444', '#94A3B8'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } } });
    if (chartSucursales) chartSucursales.destroy();
    chartSucursales = new Chart(document.getElementById('chart-sucursales').getContext('2d'), { type: 'bar', data: { labels: data.sucursales?.labels || ['JV Ju√°rez', 'Inbursa'], datasets: [{ label: 'Aprobados', data: data.sucursales?.aprobados || [52, 37], backgroundColor: '#10B981' }, { label: 'Total', data: data.sucursales?.total || [72, 55], backgroundColor: '#E2E8F0' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } }, scales: { y: { beginAtZero: true } } } });
    if (chartMensual) chartMensual.destroy();
    chartMensual = new Chart(document.getElementById('chart-mensual').getContext('2d'), { type: 'bar', data: { labels: data.mensual?.labels || ['Sep', 'Oct', 'Nov', 'Dic', 'Ene'], datasets: [{ label: 'Aprobados', data: data.mensual?.aprobados || [65, 78, 82, 89, 94], backgroundColor: '#00A8E1' }, { label: 'Total Evaluados', data: data.mensual?.total || [95, 110, 115, 120, 127], backgroundColor: '#E2E8F0' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } } });
}

function actualizarRanking(data) {
    const container = document.getElementById('ranking-reclutadores');
    const reclutadores = data.reclutadores || [{ nombre: 'Karla Flores', sucursal: 'Torre JV Ju√°rez', aprobados: 32 }, { nombre: 'Yessica Huerta', sucursal: 'Edificio Inbursa', aprobados: 28 }, { nombre: 'Jezabel Monterrosas', sucursal: 'Edificio Inbursa', aprobados: 21 }];
    let html = '';
    reclutadores.forEach((r, idx) => { const posClass = idx === 0 ? 'gold' : idx === 1 ? 'silver' : idx === 2 ? 'bronze' : 'normal'; html += `<li class="ranking-item"><span class="ranking-position ${posClass}">${idx + 1}</span><div class="ranking-info"><div class="ranking-name">${r.nombre}</div><div class="ranking-detail">${r.sucursal}</div></div><span class="ranking-value">${r.aprobados}</span></li>`; });
    container.innerHTML = html;
}

function abrirModalEnvio(idx) {
    aspiranteSeleccionado = resultadosData[idx];
    document.getElementById('modal-nombre').textContent = aspiranteSeleccionado.nombre;
    document.getElementById('modal-info').textContent = `${aspiranteSeleccionado.sucursal} ‚Ä¢ ${aspiranteSeleccionado.puntaje}/80 pts ‚Ä¢ ${aspiranteSeleccionado.resultado}`;
    const docsDiv = document.getElementById('modal-docs-pendientes');
    if (aspiranteSeleccionado.docsPendientes && aspiranteSeleccionado.docsPendientes.length > 0) { docsDiv.innerHTML = `<div style="background: var(--warning-light); padding: 12px; border-radius: 8px; margin-bottom: 16px;"><p style="font-size: 13px; color: #92400E; font-weight: 600; margin-bottom: 8px;">‚ö†Ô∏è Documentos pendientes:</p><ul style="font-size: 12px; color: #92400E; margin: 0 0 0 16px;">${aspiranteSeleccionado.docsPendientes.map(d => `<li>${d}</li>`).join('')}</ul><p style="font-size: 11px; color: #92400E; margin-top: 8px; font-style: italic;">Se incluir√°n como recordatorio en el email.</p></div>`; }
    else { docsDiv.innerHTML = ''; }
    document.getElementById('modal-envio').classList.add('active');
}

function cerrarModal() { document.getElementById('modal-envio').classList.remove('active'); aspiranteSeleccionado = null; }

async function confirmarEnvio() {
    if (!aspiranteSeleccionado) return;
    const btn = document.getElementById('btn-confirmar-envio');
    btn.disabled = true; btn.innerHTML = '<span class="loading" style="width:14px;height:14px;border-width:2px;"></span> Enviando...';
    try {
        await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tipo: 'enviar_felicitacion', nombre: aspiranteSeleccionado.nombre, telefono: String(aspiranteSeleccionado.telefono || ''), sucursal: aspiranteSeleccionado.sucursal, puntaje: aspiranteSeleccionado.puntaje, fecha: document.getElementById('select-fecha').value }) });
        cerrarModal(); alert('‚úÖ Email enviado correctamente a ' + aspiranteSeleccionado.nombre); setTimeout(() => cargarResultados(), 2000);
    } catch (e) { alert('Error al enviar. Intenta de nuevo.'); }
    btn.disabled = false; btn.innerHTML = 'üìß Enviar Email';
}

async function descargarImagen() {
    if (!aspiranteSeleccionado) return;
    const btn = document.getElementById('btn-descargar-imagen');
    btn.disabled = true; btn.innerHTML = '<span class="loading" style="width:14px;height:14px;border-width:2px;"></span> Generando...';
    const canvas = document.createElement('canvas'); canvas.width = 800; canvas.height = 1000;
    const ctx = canvas.getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 800, 1000); gradient.addColorStop(0, '#0057B8'); gradient.addColorStop(1, '#003A70');
    ctx.fillStyle = gradient; ctx.fillRect(0, 0, 800, 1000);
    ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.fillRect(0, 0, 800, 280);
    ctx.fillStyle = 'white'; ctx.font = 'bold 48px Arial'; ctx.textAlign = 'center'; ctx.fillText('üéâ ¬°FELICIDADES!', 400, 100);
    ctx.font = '32px Arial'; ctx.fillText(aspiranteSeleccionado.nombre.split(' ')[0].toUpperCase(), 400, 160);
    ctx.font = '24px Arial'; ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.fillText('Has sido seleccionado para el equipo AT&T', 400, 210);
    ctx.fillStyle = aspiranteSeleccionado.puntaje >= 64 ? '#10B981' : '#F59E0B'; ctx.fillRect(0, 280, 800, 120);
    ctx.fillStyle = 'white'; ctx.font = 'bold 56px Arial'; ctx.fillText(aspiranteSeleccionado.puntaje + '/80', 400, 350);
    ctx.font = '24px Arial'; ctx.fillText('‚úÖ ' + aspiranteSeleccionado.resultado.toUpperCase(), 400, 385);
    ctx.fillStyle = 'white'; ctx.fillRect(40, 420, 720, 400);
    ctx.fillStyle = '#334155'; ctx.font = 'bold 28px Arial'; ctx.textAlign = 'left'; ctx.fillText('üìÖ PR√ìXIMO PASO: CAPACITACI√ìN', 80, 480);
    ctx.font = '22px Arial'; ctx.fillStyle = '#64748b'; ctx.fillText('üìÜ Fecha: Pr√≥ximo lunes', 80, 530); ctx.fillText('üïê Hora: 9:50 AM (llegada)', 80, 570); ctx.fillText('üìç Lugar: ' + aspiranteSeleccionado.sucursal, 80, 610);
    ctx.fillStyle = '#e0f2fe'; ctx.fillRect(60, 660, 680, 80);
    ctx.fillStyle = '#0369a1'; ctx.font = 'italic 16px Arial'; ctx.textAlign = 'center'; ctx.fillText('"El √©xito no se mide solo por lo que logras, sino por los obst√°culos que superas."', 400, 710);
    ctx.fillStyle = '#0057B8'; ctx.font = 'bold 18px Arial'; ctx.fillText('Confirma tu asistencia respondiendo a este mensaje', 400, 800);
    ctx.fillStyle = '#64748b'; ctx.font = '14px Arial'; ctx.fillText('Equipo de Reclutamiento AT&T | ExpertCell', 400, 950);
    const link = document.createElement('a'); link.download = 'felicitacion_' + aspiranteSeleccionado.nombre.replace(/\s+/g, '_') + '.png'; link.href = canvas.toDataURL('image/png'); link.click();
    btn.disabled = false; btn.innerHTML = 'üì± Descargar WhatsApp';
}
    </script>
</body>
</html>
